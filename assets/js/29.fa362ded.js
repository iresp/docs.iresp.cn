(window.webpackJsonp=window.webpackJsonp||[]).push([[29],{311:function(a,t,s){"use strict";s.r(t);var e=s(14),n=Object(e.a)({},(function(){var a=this,t=a._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[t("h1",{attrs:{id:"shardingsphere-数据库分库分表和优化"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#shardingsphere-数据库分库分表和优化"}},[a._v("#")]),a._v(" ShardingSphere (数据库分库分表和优化)")]),a._v(" "),t("p",[a._v("ShardingSphere有ShardingSphere-JDBC和ShardingSphere-Proxy两种方式，我们采用的是ShardingSphere-Proxy。这种方案对应用层的侵入性小，基本不需要修改应用层编码。")]),a._v(" "),t("ul",[t("li",[a._v("官网："),t("a",{attrs:{href:"https://shardingsphere.apache.org/",target:"_blank",rel:"noopener noreferrer"}},[a._v("shardingsphere.apache.org"),t("OutboundLink")],1)]),a._v(" "),t("li",[a._v("仓库地址："),t("a",{attrs:{href:"https://github.com/apache/shardingsphere",target:"_blank",rel:"noopener noreferrer"}},[a._v("github.com/apache/shardingsphere"),t("OutboundLink")],1)]),a._v(" "),t("li",[a._v("文档地址："),t("a",{attrs:{href:"https://shardingsphere.apache.org/document/current/cn/overview/",target:"_blank",rel:"noopener noreferrer"}},[a._v("shardingsphere.apache.org/document/current/cn/overview/"),t("OutboundLink")],1)])]),a._v(" "),t("h2",{attrs:{id:"什么是-shardingsphere"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#什么是-shardingsphere"}},[a._v("#")]),a._v(" 什么是 ShardingSphere")]),a._v(" "),t("p",[a._v("Apache ShardingSphere 是一款"),t("strong",[a._v("分布式")]),a._v("的数据库生态系统， 可以将任意数据库转换为分布式数据库，并通过"),t("strong",[a._v("数据分片")]),a._v("、弹性伸缩、加密等能力对原有数据库进行增强。")]),a._v(" "),t("p",[a._v("Apache ShardingSphere 设计哲学为 "),t("strong",[a._v("Database Plus")]),a._v("，旨在构建异构数据库上层的标准和生态。 它关注如何充分合理地利用数据库的计算和存储能力，而并非实现一个全新的数据库。 它站在数据库的上层视角，关注它们之间的协作多于数据库自身。")]),a._v(" "),t("h3",{attrs:{id:"开发环境准备"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#开发环境准备"}},[a._v("#")]),a._v(" 开发环境准备")]),a._v(" "),t("p",[a._v("你需要准备以下开发环境：")]),a._v(" "),t("ul",[t("li",[a._v("Docker 26，  Version:           26.1.4")]),a._v(" "),t("li",[a._v("Mariadb， 10.4")]),a._v(" "),t("li",[t("a",{attrs:{href:"https://blog.csdn.net/weixin_42607526/article/details/140331333",target:"_blank",rel:"noopener noreferrer"}},[a._v("blog.csdn.net/weixin_42607526/article/details/140331333"),t("OutboundLink")],1)]),a._v(" "),t("li",[a._v("Docker image： apache/shardingsphere-proxy:5.4.1")])]),a._v(" "),t("p",[a._v("概念图示：")]),a._v(" "),t("p",[t("img",{attrs:{src:"/ShardingProxy.svg",alt:"ShardingProxy"}})]),a._v(" "),t("h3",{attrs:{id:"配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#配置"}},[a._v("#")]),a._v(" 配置")]),a._v(" "),t("p",[a._v("下载Image：")]),a._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" pull apache/shardingsphere-proxy:5.4.1\n\n")])])]),t("p",[a._v("创建宿主机目录")]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("cd")]),a._v(" /home\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("mkdir")]),a._v(" conf\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("mkdir")]),a._v(" shardingsphere "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("&&")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("cd")]),a._v(" shardingsphere\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("mkdir")]),a._v(" ext-lib\n")])])]),t("h3",{attrs:{id:"mysql-connector-java-驱动下载"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#mysql-connector-java-驱动下载"}},[a._v("#")]),a._v(" mysql-connector-java 驱动下载")]),a._v(" "),t("p",[a._v("选用mysql-connector-java-8.0.27.jar 。")]),a._v(" "),t("p",[a._v("https://repo.maven.apache.org/maven2/mysql/mysql-connector-java/")]),a._v(" "),t("blockquote",[t("p",[a._v("注： 将下载的 mysql-connector-java--8.0.27.jar  包复制到宿主机 /home/shardingsphere/ext-lib 目录下，注意自己当前 数据库版本 选择相应的驱动包。")])]),a._v(" "),t("h3",{attrs:{id:"conf-配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#conf-配置"}},[a._v("#")]),a._v(" conf 配置")]),a._v(" "),t("p",[a._v("拷贝容器 conf 到缩主机")]),a._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v("# 创建容器\ndocker run -d --name shardingsphere --entrypoint=bash apache/shardingsphere-proxy:5.4.1\n# 复制配置\ndocker cp shardingsphere:/opt/shardingsphere-proxy/conf /home/conf\n# 删除容器\ndocker rm shardingsphere\n\n")])])]),t("p",[a._v("配置文件列表：")]),a._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("root@iZbp1c8mwxtvsejtlsd3ynZ conf"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# pwd")]),a._v("\n/home/conf\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("root@iZbp1c8mwxtvsejtlsd3ynZ conf"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# ll")]),a._v("\ntotal "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("36")]),a._v("\n-rw-r--r-- "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v(" root root "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("3529")]),a._v(" Sep "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("10")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("16")]),a._v(":41 config-encrypt.yaml\n-rw-r--r-- "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v(" root root "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("3772")]),a._v(" Sep "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("10")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("16")]),a._v(":41 config-mask.yaml\n-rw-r--r-- "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v(" root root "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("3688")]),a._v(" Sep "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("10")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("16")]),a._v(":41 config-readwrite-splitting.yaml\n-rw-r--r-- "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v(" root root "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("5210")]),a._v(" Sep "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("10")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("16")]),a._v(":41 config-shadow.yaml\n-rw-r--r-- "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v(" root root "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("6524")]),a._v(" Sep "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("11")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("17")]),a._v(":11 config-sharding.yaml\n-rw-r--r-- "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v(" root root "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("1715")]),a._v(" Sep "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("10")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("16")]),a._v(":41 hbase-db.yaml\n-rw-r--r-- "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v(" root root "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("3125")]),a._v(" Sep "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("11")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("17")]),a._v(":06 server.yaml\n")])])]),t("div",{staticClass:"language- extra-class"},[t("pre",[t("code",[a._v("                        数据库分片的话，只需要修改config-sharding.yaml和server.yaml。\n")])])]),t("p",[a._v("配置文件修改"),t("code",[a._v("server.yaml")]),a._v("：")]),a._v(" "),t("div",{staticClass:"language-properties extra-class"},[t("pre",{pre:!0,attrs:{class:"language-properties"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("authority")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v(" users")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("   -")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("user: root@%")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("     password")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("'root'")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("   -")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("user: sharding")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("     password")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("sharding")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v(" privilege")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("   type")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("ALL_PERMITTED")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#transaction:")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#  defaultType: XA")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#  providerType: Atomikos")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#sqlParser:")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#  sqlCommentParseEnabled: false")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#  sqlStatementCache:")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#    initialCapacity: 2000")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#    maximumSize: 65535")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#  parseTreeCache:")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#    initialCapacity: 128")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#    maximumSize: 1024")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#logging:")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#  loggers:")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#  - loggerName: ShardingSphere-SQL")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#    additivity: true")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#    level: INFO")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#    props:")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#      enable: false")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#sqlFederation:")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#  sqlFederationEnabled: false")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#  executionPlanCache:")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#    initialCapacity: 2000")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#    maximumSize: 65535")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("props")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#  system-log-level: INFO")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#  max-connections-size-per-query: 1")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#  kernel-executor-size: 16  # Infinite by default.")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#  proxy-frontend-flush-threshold: 128  # The default value is 128.")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#  # sql-show is the same as props in logger ShardingSphere-SQL, and its priority is lower than logging rule")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v(" sql-show")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("true")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v(" allow-range-query-with-inline-sharding")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("true")]),a._v("\n")])])]),t("h4",{attrs:{id:"配置文件修改config-sharding-yaml"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#配置文件修改config-sharding-yaml"}},[a._v("#")]),a._v(" 配置文件修改"),t("code",[a._v("config-sharding.yaml")]),a._v("：")]),a._v(" "),t("div",{staticClass:"language-properties extra-class"},[t("pre",{pre:!0,attrs:{class:"language-properties"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("databaseName")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("sharding_db")]),a._v("\n\n\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("dataSources")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v(" ds_0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("   url")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("jdbc:mysql://172.30.156.243:3306/sharding11?characterEncoding=UTF-8&useUnicode=true&useSSL=false&tinyInt1isBit=false&allowPublicKeyRetrieval=true&serverTimezone=Asia/Shanghai")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("   username")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("root")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("   password")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("root")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("   connectionTimeoutMilliseconds")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("30000")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("   idleTimeoutMilliseconds")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("60000")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("   maxLifetimeMilliseconds")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("1800000")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("   maxPoolSize")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("50")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("   minPoolSize")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("1")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v(" ds_1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("   url")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("jdbc:mysql://mariadb:3306/sharding22?characterEncoding=UTF-8&useUnicode=true&useSSL=false&tinyInt1isBit=false&allowPublicKeyRetrieval=true&serverTimezone=Asia/Shanghai")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("   username")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("root")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("   password")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("root")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("   connectionTimeoutMilliseconds")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("30000")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("   idleTimeoutMilliseconds")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("60000")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("   maxLifetimeMilliseconds")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("1800000")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("   maxPoolSize")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("50")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("   minPoolSize")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("1")]),a._v("\n\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("rules")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("-")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("!SHARDING")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v(" tables")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("   hsoclaimtable")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("     actualDataNodes")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("ds_${0..1}.hsoclaimtable")]),a._v("\n\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v(" defaultDatabaseStrategy")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("   standard")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("     shardingColumn")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("id")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("     shardingAlgorithmName")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("database_inline")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v(" defaultTableStrategy")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("   none")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#  defaultAuditStrategy:")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#    auditorNames:")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#      - sharding_key_required_auditor")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#    allowHintDisable: true")]),a._v("\n\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v(" shardingAlgorithms")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("   database_inline")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("     type")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("INLINE")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("     props")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("       algorithm-expression")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("ds_${id % 2}")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("       allow-range-query-with-inline-sharding")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("true")]),a._v("\n")])])]),t("h3",{attrs:{id:"运行docker"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#运行docker"}},[a._v("#")]),a._v(" 运行Docker")]),a._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[a._v("  "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" run "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-d")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--name")]),a._v(" shardingsphere "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v(" /home/conf:/opt/shardingsphere-proxy/conf "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v(" /home/shardingsphere/ext-lib:/opt/shardingsphere-proxy/ext-lib "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v(" /etc/localtime:/etc/localtime "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-e")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("JVM_OPTS")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"-Djava.awt.headless=true"')]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-e")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("CGROUP_MEM_OPTS")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"-XX:InitialRAMPercentage=80.0 -XX:MaxRAMPercentage=80.0 -XX:MinRAMPercentage=80.0"')]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-e")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("PORT")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("3308")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("3308")]),a._v(":3308 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--network")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("uat-network  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n apache/shardingsphere-proxy:5.4.1\n")])])]),t("p",[a._v("检查Docker日志，确保正常启动")]),a._v(" "),t("h2",{attrs:{id:"连接shardingsphere-proxy"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#连接shardingsphere-proxy"}},[a._v("#")]),a._v(" 连接ShardingSphere-Proxy")]),a._v(" "),t("p",[a._v("根据配置，ShardingSphere-Proxy会提供数据库的连接接口给应用层，应用层可以像连接普通数据库一样连接Sharding。")]),a._v(" "),t("p",[a._v("我们的系统支持多数据源，配置多数据源：")]),a._v(" "),t("div",{staticClass:"language-properties extra-class"},[t("pre",{pre:!0,attrs:{class:"language-properties"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("        # 多数据源配置")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("        ucb-datasource")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("          url")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("jdbc:mysql://192.168.0.109:3306/sharding1?characterEncoding=UTF-8&useUnicode=true&useSSL=false&tinyInt1isBit=false&allowPublicKeyRetrieval=true&serverTimezone=Asia/Shanghai")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("          username")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("root")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("          password")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("root")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("          driver-class-name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("com.mysql.cj.jdbc.Driver")]),a._v("\n")])])]),t("p",[a._v("相应的程序中使用注解指定数据源：")]),a._v(" "),t("div",{staticClass:"language-java extra-class"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[a._v("@Slf4j")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[a._v("@Service")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[a._v("@DS")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"ucb-datasource"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("public")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("class")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("HsoclaimtableServiceImpl")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("extends")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("ServiceImpl")]),t("span",{pre:!0,attrs:{class:"token generics"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("<")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("HsoclaimtableMapper")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("Hsoclaimtable")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),a._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("implements")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("IHsoclaimtableService")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[a._v("@Autowired")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("private")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("HsoclaimtableMapper")]),a._v(" hsoclaimtableMapper"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("public")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("long")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("countAll")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("return")]),a._v(" hsoclaimtableMapper"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("countAll")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("public")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("void")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("test")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("long")]),a._v(" startId"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("long")]),a._v(" endId"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("long")]),a._v(" minId "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" startId"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n        "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("List")]),t("span",{pre:!0,attrs:{class:"token generics"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("<")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("Hsoclaimtable")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),a._v(" hsoclaimtableList "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("new")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("ArrayList")]),t("span",{pre:!0,attrs:{class:"token generics"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("<")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n")])])]),t("h3",{attrs:{id:"案例"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#案例"}},[a._v("#")]),a._v(" 案例")]),a._v(" "),t("p",[a._v("理赔信息：")]),a._v(" "),t("p",[a._v("http://localhost:3100/iresp/HsoclaimtableList")]),a._v(" "),t("h2",{attrs:{id:"注意"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#注意"}},[a._v("#")]),a._v(" 注意")]),a._v(" "),t("ul",[t("li",[a._v("目前测试"),t("strong",[a._v("5.4.1")]),a._v("版本是成功的，其他版本都不行。")]),a._v(" "),t("li",[a._v("ShardingSphere-proxy只支持mysql和postGresql数据库，其他数据库只能用ShardingSphere-jdbc")]),a._v(" "),t("li",[a._v("数据库表的分片字段必须是"),t("strong",[a._v("BIGINT，数字型")]),a._v("，才可以，字符串类型测试过，不成功")]),a._v(" "),t("li",[a._v("为了保证性能，分片数据库最好在"),t("strong",[a._v("同一个子网")]),a._v("里")]),a._v(" "),t("li",[a._v("分库分表对于SQL影响比较大，很多复杂的SQL可能都会有问题，真实使用时需要测试每个SQL")]),a._v(" "),t("li",[a._v("分库分表后，每个分片的性能优化依然很重要，可以用索引来优化")]),a._v(" "),t("li",[a._v("分库分表后，其他的数据库性能优化方案依然很重要，比如Redis缓存")])])])}),[],!1,null,null,null);t.default=n.exports}}]);